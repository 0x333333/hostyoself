<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="https://share.schollz.com/static/dropzone.css">
    <link rel="stylesheet" href="https://share.schollz.com/static/style.css">
    <title>omniserver</title>
    <style>
    .main {
        padding-top: 20px;
    }

    .list {
        display: flex;
        flex-wrap: wrap;
    }

    .list>div {
        padding: 0.4em;
    }

    body {
        text-decoration-skip: ink;
    }

    .hide {
        display: none;
    }

    textarea {
        width: 100%;
        border: none;
        resize: none;
        height: 20em;
        border: 1px solid #ccc;
        background-color: #f5f5f5;
        padding: 1em;
        font-size: 0.9em;
    }

    details>p>code {
        background-color: inherit;
    }
    </style>
</head>

<body>
    <main>
        <h1 align="center"><a href="/">omniserver</a> </h1>
        <p id="errormessage" class="error"></p>
        <p>Serve your files from your browser through this relay: <strong>{{.PublicURL}}</strong>.</p>
        <details>
            <summary>Click here for FAQ.</summary>
            <h2 id="faq">FAQ</h2>
            <p><strong>How do I start web hosting?</strong> You will need to setup port forwarding, a dynamic DNS, name registration, MySQL, PHP, Apache and take a online course in Javascript. </p>
            <p>Just <em>kidding</em>! You don't need any of that crap. Just drag and drop a folder, or select a file. That's literally it. Now you can host a website from your laptop or your phone or your smartwatch or your toaster.</p>
            <p><strong>How is this possible?</strong> When the server you point at gets a request for a webpage, the server turns back and asks <em>you</em> for that content and will use what you provide for the original request.</p>
            <p><strong>Seriously, how is this possible?</strong> The relay uses websockets in your browser to process GET commands.</p>
            <p><strong>Won't my website disappear when I close my browser?</strong> Yep! There is a command-line tool that doesn't require a browser so it can run in the background if you need that. But yes, if your computer turns off then your site is down. Welcome to the joys of hosting a site on the internet.</p>
            <p><strong>Won't I have to reload my browser if I change a file?</strong> Yep! Welcome to the joys of Javascript.</p>
            <p><strong>Whats the largest file I can host using this?</strong> <code>¯\_(ツ)_/¯</code></p>
            <p><strong>Should I use this to host a website?</strong> Dear god yes.</p>
            <p><strong>Does this use AI or blockchain?</strong> Sure, why not. </p>
            <p><strong>What inspired this?</strong> <a href="https://github.com/joewalnes/websocketd">websocketd</a> which shows the magic of websockets and <a href="https://beakerbrowser.com/">beaker browser</a> which shows the magic of browser hosting.</p>
            <p><strong>What's the point of this?</strong> You can host a website! You can share a file! Anything you want, directly from your browser!</p>
        </details>
        <div id="filesBox" class="dropzone">
            <div class="dz-message" data-dz-message><span>Drag and drop a folder or click to share a file.<br>
                    <p><small></small></p>
                </span></div>
        </div>
        <div id="console" class="dropzone hide">
            <div id="consoleHeader"></div>
            <details>
                <summary>Files served</summary>
                <div id="fileList"></div>
            </details>
            <h3>Console:</h3>
            <textarea id="consoleText" readonly></textarea>
        </div>
        <footer>
            <!--             <p align="center" style="margin-bottom:0">
                <img src="/static/logo47.png" style="max-width: 100px">
            </p>
 -->
            <p align="center">Made by <a href="https://github.com/schollz">schollz</a>, source available on <a href="https://github.com/schollz/omniserve">Github</a>. <a href="/static/terms.html">Terms of Use</a>.</p>
        </footer>
    </main>
    <script src="https://share.schollz.com/static/dropzone.js"></script>
    <script>
    var files = [];
    var isConnected = false;

    function consoleLog(s) {
        console.log(s);
        if (typeof s === 'object') {
            s = JSON.stringify(s);
        }

        if (!(s.startsWith("[debug]"))) {
            document.getElementById("consoleText").value = document.getElementById("consoleText").value + s + "\n";
            document.getElementById("consoleText").scrollTop = document.getElementById("consoleText").scrollHeight;
        }
    }

    function humanFileSize(bytes, si) {
        var thresh = si ? 1000 : 1024;
        if (Math.abs(bytes) < thresh) {
            return bytes + ' B';
        }
        var units = si ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB',
            'EiB', 'ZiB', 'YiB'
        ];
        var u = -1;
        do {
            bytes /= thresh;
            ++u;
        } while (Math.abs(bytes) >= thresh && u < units.length - 1);
        return bytes.toFixed(1) + ' ' + units[u];
    }

    var Name = "";
    var filesize = 0;

    (function(Dropzone) {
        Dropzone.autoDiscover = false;

        let drop = new Dropzone('div#filesBox', {
            maxFiles: 1000,
            url: '/',
            method: 'post',
            createImageThumbnails: false,
            previewTemplate: "<div id='preview' class='.dropzone-previews'></div>",
            autoProcessQueue: false,
        });

        drop.on('addedfile', function(file) {
            files.push(file);
            domain = files[0].webkitRelativePath.split("/")[0];
            if (domain == "") {
                domain = files[0].name;
            }
            if (!(isConnected)) {
                isConnected = true;
                socketSend({
                    "type": "domain",
                    "message": domain,
                })
            }
            document.getElementById("consoleHeader").innerHTML = `<p>Your files are served at: <strong><a href="/${domain}" target="_blank">{{.PublicURL}}/${domain}</a></strong></p>`;
            html = `<ul>`
            for (i = 0; i < files.length; i++) {
                var urlToFile = files[i].name;

                if ('fullPath' in files[i]) {
                    urlToFile = files[i].fullPath;
                }
                html = html +
                    `<li><a href="/${urlToFile}" target="_blank">/${urlToFile}</a></li>`
            }
            html = html + `</ul>`;
            document.getElementById("fileList").innerHTML = html;
            document.getElementById("filesBox").classList.add("hide");
            document.getElementById("console").classList.remove("hide");

        })

    })(Dropzone);

    var socket; // websocket


    /* websockets */
    function socketSend(data) {
        if (socket == null) {
            return
        }
        if (socket.readyState != 1) {
            return
        }
        jsonData = JSON.stringify(data);
        socket.send(jsonData);
        if (jsonData.length > 100) {
            jsonData = jsonData.substring(0, 99) + "...";
        }
        consoleLog("[debug] ws-> " + jsonData)
    }

    const socketMessageListener = (event) => {
        var data = JSON.parse(event.data);
        if (!('type' in data && 'message' in data)) {
            consoleLog(`[warn] got bad data ${event.data}`);
            return
        }
        console.log(data)
        consoleLog(`[debug] ${data.message}`)
        if (data.type == "get") {
            var foundFile = false
            for (i = 0; i < files.length; i++) {
                if (files[i].webkitRelativePath == data.message || files[i].name == data.message) {
                    var reader = new FileReader();
                    reader.onload = function(theFile) {
                        socketSend({
                            type: "get",
                            message: reader.result,
                            success: true,
                        })
                        consoleLog(`${data.ip} [${(new Date()).toUTCString()}] /${data.message} 200 ${files[i].size}`);
                    };
                    reader.readAsDataURL(files[i]);
                    foundFile = true
                    break
                }
            }
            if (foundFile == false) {
                socketSend({
                    type: "get",
                    message: "not found",
                    success: false,
                })
                consoleLog(`[info] ${data.message} 404`);
            }
        } else if (data.type == "message") {
            console.log(`[info] ${data.message}`);
        } else {
            consoleLog(`[debug] unknown`);
        }
    };
    const socketOpenListener = (event) => {
        consoleLog('[info] connected');
    };

    const socketCloseListener = (event) => {
        if (socket) {
            consoleLog('[info] disconnected');
        }
        var url = window.origin.replace("http", "ws") + '/ws';
        try {
            socket = new WebSocket(url);
            socket.addEventListener('open', socketOpenListener);
            socket.addEventListener('message', socketMessageListener);
            socket.addEventListener('close', socketCloseListener);
        } catch (err) {
            consoleLog("[info] no connection available")
        }
    };


    socketCloseListener();
    </script>
</body>

</html>